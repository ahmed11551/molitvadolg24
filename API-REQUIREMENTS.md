# Требования к Backend API для Владимира

## Статус интеграции

| Модуль | API | Статус | Комментарий |
|--------|-----|--------|-------------|
| e-Replika | `/terms` | ⚠️ Требуется | Возвращает 404 |
| e-Replika | `/calendar/*` | ⚠️ Требуется | Конвертация дат |
| e-Replika | `/duas` | ⚠️ Требуется | Список дуа |
| e-Replika | `/adhkar` | ⚠️ Требуется | Список азкаров |
| e-Replika | `/reports/pdf` | ⚠️ Требуется | Генерация PDF |
| Supabase | `prayer-debt-api` | ✅ Готов | Работает |
| Supabase | `spiritual-path-api` | ✅ Готов | Работает |
| Supabase | `smart-tasbih-api` | ✅ Готов | Работает |

---

## 1. Отсутствующие эндпоинты e-Replika API

### 1.1 GET /terms — Исламские термины

**Описание:** Словарь терминов для раздела "Словарик"

**Требуемый формат ответа:**
```json
[
  {
    "term": "Каза",
    "definition": "Восполнение пропущенного обязательного намаза",
    "transliteration": "Qada",
    "arabic": "قضاء"
  },
  {
    "term": "Булюг",
    "definition": "Совершеннолетие, возраст обязательности намаза",
    "transliteration": "Bulugh",
    "arabic": "بلوغ"
  },
  {
    "term": "Хайд",
    "definition": "Менструация у женщин",
    "transliteration": "Haid",
    "arabic": "حيض"
  },
  {
    "term": "Нифас",
    "definition": "Послеродовое кровотечение",
    "transliteration": "Nifas",
    "arabic": "نفاس"
  },
  {
    "term": "Сафар",
    "definition": "Путешествие с правом сокращения намаза",
    "transliteration": "Safar",
    "arabic": "سفر"
  }
]
```

**Минимально необходимые термины:**
- Каза, Булюг, Хайд, Нифас, Сафар
- Мазхаб, Витр, Ракаат
- Фаджр, Зухр, Аср, Магриб, Иша

---

### 1.2 POST /calendar/convert-to-hijri — Конвертация даты

**Описание:** Конвертация григорианской даты в хиджру

**Запрос:**
```json
{
  "date": "2024-01-15"
}
```

**Требуемый формат ответа:**
```json
{
  "year": 1445,
  "month": 7,
  "day": 3,
  "month_name": "Раджаб",
  "weekday": "Понедельник"
}
```

**Примечание:** Если эндпоинт недоступен, фронтенд использует приблизительную формулу, что может давать погрешность ±1 день.

---

### 1.3 POST /calendar/convert-from-hijri — Конвертация из хиджры

**Описание:** Конвертация даты хиджры в григорианскую

**Запрос:**
```json
{
  "year": 1445,
  "month": 7,
  "day": 3
}
```

**Требуемый формат ответа:**
```json
{
  "date": "2024-01-15",
  "formatted": "15 января 2024"
}
```

---

### 1.4 GET /duas — Список дуа

**Описание:** Полный каталог дуа по категориям

**Требуемый формат ответа:**
```json
[
  {
    "id": "dua_sleep_1",
    "category": "sleep",
    "arabic": "بِاسْمِكَ اللَّهُمَّ أَمُوتُ وَأَحْيَا",
    "transcription": "Bismika Allahumma amutu wa ahya",
    "russian_transcription": "Бисмикя Аллахумма амуту ва ахья",
    "translation": "С Твоим именем, о Аллах, я умираю и оживаю",
    "reference": "Бухари, 6324",
    "audio_url": "https://cdn.example.com/audio/dua_sleep_1.mp3"
  }
]
```

**Требуемые категории:**
| Категория | Описание | Мин. кол-во |
|-----------|----------|-------------|
| `sleep` | Перед сном | 5 |
| `wake` | После пробуждения | 3 |
| `prayer` | После намаза | 10 |
| `morning` | Утренние | 5 |
| `evening` | Вечерние | 5 |
| `food` | До/после еды | 4 |
| `travel` | В путешествии | 5 |
| `hajj` | В хадже | 5 |
| `general` | Общие | 10 |

---

### 1.5 GET /duas/{id}/audio — Аудио дуа

**Описание:** Аудиофайл или URL для конкретного дуа

**Формат ответа:** 
- `audio/mpeg` — прямой аудиофайл
- или JSON: `{ "audio_url": "https://..." }`

**Требования к аудио:**
- Формат: MP3
- Качество: минимум 128 kbps
- Чёткое произношение арабского текста

---

### 1.6 GET /adhkar — Список азкаров

**Описание:** Каталог азкаров (поминаний)

**Требуемый формат ответа:**
```json
[
  {
    "id": "adhkar_morning_1",
    "category": "morning",
    "title": "Аят аль-Курси",
    "arabic": "اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ...",
    "transcription": "Allahu la ilaha illa huwal hayyul qayyum...",
    "russian_transcription": "Аллаху ля иляха илля хуваль хаййуль каййум...",
    "translation": "Аллах — нет божества, кроме Него, Живого, Вседержителя...",
    "count": 1,
    "reference": "Коран, 2:255",
    "audio_url": "https://cdn.example.com/audio/adhkar_morning_1.mp3"
  }
]
```

**Требуемые категории:**
| Категория | Описание |
|-----------|----------|
| `morning` | Утренние азкары |
| `evening` | Вечерние азкары |
| `after_prayer` | После намаза |
| `tasbih` | Тасбих (СубханАллах, Альхамдулиллях, Аллаху Акбар) |
| `istighfar` | Истигфар (просьба о прощении) |

---

### 1.7 GET /salawat — Список салаватов

**Описание:** Благословения на Пророка ﷺ

**Требуемый формат ответа:**
```json
[
  {
    "id": "salawat_1",
    "arabic": "اللَّهُمَّ صَلِّ عَلَى مُحَمَّدٍ وَعَلَى آلِ مُحَمَّدٍ",
    "transcription": "Allahumma salli ala Muhammad wa ala ali Muhammad",
    "russian_transcription": "Аллахумма салли аля Мухаммад ва аля али Мухаммад",
    "translation": "О Аллах, благослови Мухаммада и род Мухаммада",
    "reference": "Бухари",
    "audio_url": "https://..."
  }
]
```

---

### 1.8 GET /kalimas — Шесть калим

**Описание:** Основополагающие формулы веры

**Требуемый формат ответа:**
```json
[
  {
    "id": "kalima_1",
    "name": "Первая калима (Таййиба)",
    "arabic": "لَا إِلَٰهَ إِلَّا ٱللَّٰهُ مُحَمَّدٌ رَسُولُ ٱللَّٰهِ",
    "transcription": "La ilaha illallah Muhammadur Rasulullah",
    "russian_transcription": "Ля иляха илляллах Мухаммадур Расулюллах",
    "translation": "Нет божества, кроме Аллаха, Мухаммад — посланник Аллаха",
    "audio_url": "https://..."
  }
]
```

**Все 6 калим:**
1. Таййиба (Чистота)
2. Шахада (Свидетельство)
3. Тамджид (Прославление)
4. Таухид (Единобожие)
5. Астагфирулла (Покаяние)
6. Радд-е-Куфр (Отвержение неверия)

---

### 1.9 GET /names-of-allah — 99 имён Аллаха

**Описание:** Асма уль-Хусна

**Требуемый формат ответа:**
```json
[
  {
    "number": 1,
    "arabic": "الرَّحْمَٰنُ",
    "transcription": "Ar-Rahman",
    "russian_transcription": "Ар-Рахман",
    "translation": "Милостивый",
    "meaning": "Тот, чья милость объемлет всё сущее",
    "audio_url": "https://..."
  }
]
```

---

### 1.10 POST /reports/pdf — Генерация PDF

**Описание:** Создание PDF-отчёта по каза-намазам

**Запрос:**
```json
{
  "user_id": "telegram_123",
  "data": {
    "debt_calculation": {
      "period": {
        "start": "2005-01-01",
        "end": "2024-01-01"
      },
      "missed_prayers": {
        "fajr": 6000,
        "dhuhr": 6000,
        "asr": 6000,
        "maghrib": 6000,
        "isha": 6000,
        "witr": 6000
      }
    },
    "repayment_progress": {
      "completed_prayers": {
        "fajr": 100,
        "dhuhr": 150,
        "asr": 120,
        "maghrib": 130,
        "isha": 110,
        "witr": 90
      }
    }
  },
  "language": "ru",
  "include_charts": true
}
```

**Формат ответа:**
- Content-Type: `application/pdf`
- или JSON: `{ "url": "https://cdn.example.com/reports/user_123.pdf" }`

**Содержимое PDF:**
- Заголовок с датой генерации
- Общая статистика долга
- Таблица по каждому намазу
- Прогресс восполнения (%)
- График (если `include_charts: true`)
- QR-код для приложения

---

## 2. Требования к аутентификации

### Telegram Mini App

```http
Authorization: Bearer <initData>
```

Где `initData` — строка из `window.Telegram.WebApp.initData`

**Валидация на backend:**
1. Парсинг initData как URLSearchParams
2. Извлечение `hash` и `data_check_string`
3. Проверка HMAC-SHA256 с bot token
4. Проверка `auth_date` (не старше 24 часов)

### API Key (опционально)

```http
X-API-Key: <api_key>
```

---

## 3. Требования к CORS

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Headers: authorization, x-client-info, apikey, content-type, x-api-key
Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
```

---

## 4. Требования к производительности

| Метрика | Требование |
|---------|------------|
| Время ответа (p95) | < 500ms |
| Время ответа (p99) | < 2s |
| Доступность | 99.5% |
| Rate limit | 100 req/min на пользователя |

---

## 5. Требования к данным

### Кодировка
- UTF-8 везде
- Арабский текст в Unicode (не изображениями)

### Формат дат
- ISO 8601: `2024-01-15T12:00:00Z`
- Только дата: `2024-01-15`

### ID
- Строки, уникальные в рамках сущности
- Рекомендуется: `{entity}_{uuid}` или `{entity}_{number}`

---

## 6. Приоритеты реализации

### Критические (блокируют запуск)
1. ✅ Supabase Edge Functions — готовы
2. ⚠️ `/terms` — используется fallback
3. ⚠️ `/calendar/*` — используется формула

### Высокий приоритет
4. `/duas` с аудио
5. `/adhkar` с аудио
6. `/reports/pdf`

### Средний приоритет
7. `/salawat`
8. `/kalimas`
9. `/names-of-allah`

---

## 7. Контакты для вопросов

- **Документация e-Replika**: https://bot.e-replika.ru/docs
- **Telegram**: @vladimir_backend (пример)

---

## 8. Чеклист перед интеграцией

- [ ] Все эндпоинты отвечают с корректными CORS-заголовками
- [ ] Аутентификация через Telegram initData работает
- [ ] Возвращаются корректные HTTP-коды ошибок
- [ ] Формат ответов соответствует спецификации
- [ ] Аудиофайлы доступны и имеют корректный Content-Type
- [ ] PDF генерируется корректно на русском языке
- [ ] Rate limiting настроен и документирован

